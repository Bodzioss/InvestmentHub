@inherits LayoutComponentBase
@using InvestmentHub.Web.Client.Services
@inject LayoutService LayoutService
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@using Fluxor
@using InvestmentHub.Web.Client.Store.User

<MudThemeProvider Theme="@_theme" IsDarkMode="@LayoutService.IsDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h5" Class="ml-3">Investment Hub</MudText>
        <MudSpacer />
        <AuthorizeView>
            <Authorized>
                <MudMenu Label="@context.User.Identity?.Name" Variant="Variant.Filled" Color="Color.Secondary" EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
                    <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/user-profile"))">Zarządzaj kontem</MudMenuItem>
                    <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/change-password"))">Zmień hasło</MudMenuItem>
                    <MudMenuItem OnClick="Logout">Wyloguj</MudMenuItem>
                </MudMenu>
            </Authorized>
            <NotAuthorized>
                <MudButton Variant="Variant.Text" Color="Color.Inherit" OnClick="@(() => NavigationManager.NavigateTo("/login"))">Logowanie</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="@(() => NavigationManager.NavigateTo("/register"))" Class="ml-2">Rejestracja</MudButton>
            </NotAuthorized>
        </AuthorizeView>
        <MudIconButton Icon="@(LayoutService.IsDarkMode ? Icons.Material.Filled.Brightness7 : Icons.Material.Filled.Brightness4)" 
                       Color="Color.Inherit" 
                       OnClick="@LayoutService.ToggleDarkMode" Class="ml-2" />
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private MudTheme _theme = new();

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    [Inject]
    private IDispatcher Dispatcher { get; set; } = default!;

    [Inject]
    private IState<UserState> UserState { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        LayoutService.MajorUpdateOccured += (s, e) => StateHasChanged();
        await LayoutService.LoadUserPreferences();
        
        _theme = new MudTheme()
        {
            PaletteLight = new PaletteLight()
            {
                Primary = Colors.Blue.Default,
                Secondary = Colors.Green.Accent4,
                AppbarBackground = Colors.Blue.Darken2,
                Background = Colors.Gray.Lighten5,
                Surface = Colors.Shades.White,
                DrawerBackground = Colors.Shades.White,
                TextPrimary = Colors.Gray.Darken4,
                TextSecondary = Colors.Gray.Darken2,
                ActionDefault = Colors.Gray.Darken3,
            },
            PaletteDark = new PaletteDark()
            {
                Primary = Colors.Blue.Lighten1,
            }
        };
        LayoutService.SetBaseTheme(_theme);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userId = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (!string.IsNullOrEmpty(userId) && UserState.Value.SelectedUserId != userId)
                {
                    Dispatcher.Dispatch(new InvestmentHub.Web.Client.Store.User.SelectUserAction(userId));
                }
            }
        }
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("authToken");
        ((InvestmentHub.Web.Client.Auth.CustomAuthenticationStateProvider)AuthStateProvider).NotifyUserLogout();
        NavigationManager.NavigateTo("/login");
    }
}
