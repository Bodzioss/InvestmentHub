@page "/change-password"
@using InvestmentHub.Contracts.Auth
@using InvestmentHub.Web.Client.Services
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Zmień hasło</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudForm @ref="_form" @bind-IsValid="@_success">
            <MudTextField T="string" Label="Obecne hasło" InputType="InputType.Password" @bind-Value="_model.CurrentPassword" Required="true" RequiredError="Obecne hasło jest wymagane" />
            <MudTextField T="string" Label="Nowe hasło" InputType="InputType.Password" @bind-Value="_model.NewPassword" Required="true" RequiredError="Nowe hasło jest wymagane" Validation="@(new Func<string, IEnumerable<string>>(PasswordStrength))" />
            <MudTextField T="string" Label="Potwierdź nowe hasło" InputType="InputType.Password" @bind-Value="_confirmPassword" Required="true" RequiredError="Potwierdzenie hasła jest wymagane" Validation="@(new Func<string, string>(PasswordMatch))" />
        </MudForm>
    </MudCardContent>
    <MudCardActions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!_success)" OnClick="Submit">Zmień hasło</MudButton>
    </MudCardActions>
</MudCard>

@code {
    private ChangePasswordRequest _model = new();
    private string _confirmPassword = string.Empty;
    private bool _success;
    private MudForm _form = default!;

    private IEnumerable<string> PasswordStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "Hasło jest wymagane!";
            yield break;
        }
        if (pw.Length < 6)
            yield return "Hasło musi mieć co najmniej 6 znaków";
    }

    private string? PasswordMatch(string arg)
    {
        if (_model.NewPassword != arg)
            return "Hasła nie są identyczne";
        return null;
    }

    private async Task Submit()
    {
        try
        {
            await AuthService.ChangePassword(_model);
            Snackbar.Add("Hasło zostało zmienione pomyślnie", Severity.Success);
            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Błąd zmiany hasła: {ex.Message}", Severity.Error);
        }
    }
}
