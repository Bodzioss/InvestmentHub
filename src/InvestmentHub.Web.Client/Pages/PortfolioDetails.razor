@page "/portfolio/{PortfolioId}"
@using Fluxor
@using InvestmentHub.Web.Client.Store.Portfolio
@using InvestmentHub.Web.Client.Store.Investment
@using InvestmentHub.Web.Client.Store.User
@using InvestmentHub.Web.Client.Store.MarketData
@using InvestmentHub.Contracts
@using InvestmentHub.Web.Client.Components
@inject IState<PortfolioState> PortfolioState
@inject IState<InvestmentState> InvestmentState
@inject IState<UserState> UserState
@inject IState<MarketDataState> MarketDataState
@inject IDispatcher Dispatcher
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject SignalRService SignalRService
@inject IPortfoliosApi PortfoliosApi
@implements IAsyncDisposable

<PageTitle>Portfolio Details</PageTitle>

@if (_currentPortfolio == null)
{
    <MudContainer MaxWidth="MaxWidth.Large">
        <MudAlert Severity="Severity.Warning">Portfolio not found</MudAlert>
        <MudButton Href="/" Variant="Variant.Filled" Color="Color.Primary" Class="mt-4">
            Back to Dashboard
        </MudButton>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">
        <!-- Portfolio Header -->
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                                      Color="Color.Default" 
                                      Href="/" />
                        <div>
                            <MudText Typo="Typo.h4">@_currentPortfolio.Name</MudText>
                            @if (!string.IsNullOrEmpty(_currentPortfolio.Description))
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@_currentPortfolio.Description</MudText>
                            }
                        </div>
                    </MudStack>
                </div>
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Edit"
                              OnClick="OpenEditPortfolioDialog">
                        Edit
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Error" 
                              StartIcon="@Icons.Material.Filled.Delete"
                              OnClick="DeletePortfolio">
                        Delete
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Add"
                              OnClick="OpenAddInvestmentDialog">
                        Add Investment
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>

        <!-- Portfolio Summary Cards -->
        @{
            // Compute totals dynamically based on current investments and market prices
            decimal totalValue = 0;
            decimal totalCost = 0;
            decimal gainLoss = 0;
            string currency = _currentPortfolio.Currency;
            
            if (InvestmentState.Value.Investments.Any())
            {
                foreach (var inv in InvestmentState.Value.Investments)
                {
                    totalCost += inv.PurchasePrice.Amount * inv.Quantity;
                    
                    var marketPrice = GetMarketPrice(inv.Symbol.Ticker);
                    if (marketPrice != null)
                    {
                        totalValue += marketPrice.Price * inv.Quantity;
                    }
                    else
                    {
                        totalValue += inv.CurrentValue.Amount; // Fallback to last known value
                    }
                }
                
                gainLoss = totalValue - totalCost;
            }
        }
        
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="1">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Value</MudText>
                        <MudText Typo="Typo.h5" Color="Color.Primary">
                            @totalValue.ToString("N2") @currency
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="1">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Cost</MudText>
                        <MudText Typo="Typo.h5">
                            @totalCost.ToString("N2") @currency
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="1">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Gain/Loss</MudText>
                        <MudText Typo="Typo.h5" Color="@GetGainLossColor(gainLoss)">
                            @gainLoss.ToString("N2") @currency
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="1">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Active Investments</MudText>
                        <MudText Typo="Typo.h5">@_currentPortfolio.ActiveInvestmentCount</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Investments Table -->
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">Investments</MudText>

            @if (InvestmentState.Value.IsLoading)
            {
                <MudProgressLinear Indeterminate="true" />
            }
            else if (!InvestmentState.Value.Investments.Any())
            {
                <MudPaper Class="pa-8" Elevation="0" Outlined="true">
                    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Large" Color="Color.Default" />
                        <MudText Typo="Typo.h6">No investments yet</MudText>
                        <MudText Typo="Typo.body2" Class="mb-4">Add your first investment to start tracking your portfolio.</MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddInvestmentDialog">
                            Add Investment
                        </MudButton>
                    </MudStack>
                </MudPaper>
            }
            else
            {
                <MudTable Items="@InvestmentState.Value.Investments" 
                         Hover="true" 
                         Striped="true" 
                         Dense="true"
                         Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh>Symbol</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Quantity</MudTh>
                        <MudTh>Purchase Price</MudTh>
                        <MudTh>Market Price</MudTh>
                        <MudTh>Market Value</MudTh>
                        <MudTh>Gain/Loss</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Symbol">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@context.Symbol.Ticker</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Symbol.Exchange</MudText>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Type">
                            <MudChip T="string" Size="Size.Small" Color="GetAssetTypeColor(context.Symbol.AssetType)">
                                @context.Symbol.AssetType
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Quantity">@context.Quantity.ToString("N2")</MudTd>
                        <MudTd DataLabel="Purchase Price">
                            @context.PurchasePrice.Amount.ToString("N2") @context.PurchasePrice.Currency
                        </MudTd>
                        <MudTd DataLabel="Market Price">
                            @{
                                var marketPrice = GetMarketPrice(context.Symbol.Ticker);
                            }
                            @if (marketPrice != null)
                            {
                                <MudText Typo="Typo.body2">@marketPrice.Price.ToString("N2") @marketPrice.Currency</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@marketPrice.Timestamp.ToLocalTime().ToString("g")</MudText>
                            }
                            else
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            }
                        </MudTd>
                        <MudTd DataLabel="Market Value">
                            @{
                                var marketPrice = GetMarketPrice(context.Symbol.Ticker);
                                var marketValue = marketPrice != null ? marketPrice.Price * context.Quantity : 0;
                                var currency = marketPrice?.Currency ?? context.CurrentValue.Currency;
                            }
                            @if (marketPrice != null)
                            {
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@marketValue.ToString("N2") @currency</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Gain/Loss">
                            @{
                                var marketPrice = GetMarketPrice(context.Symbol.Ticker);
                                var marketValue = marketPrice != null ? marketPrice.Price * context.Quantity : 0;
                                var cost = context.PurchasePrice.Amount * context.Quantity;
                                var gainLoss = marketValue - cost;
                                var percentage = cost > 0 ? (gainLoss / cost * 100) : 0;
                            }
                            @if (marketPrice != null)
                            {
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2" Color="@GetGainLossColor(gainLoss)">
                                        @gainLoss.ToString("N2")
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="@GetGainLossColor(gainLoss)">
                                        (@percentage.ToString("N2")%)
                                    </MudText>
                                </MudStack>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Size="Size.Small" Color="GetStatusColor(context.Status)">
                                @context.Status
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Actions">
                            <MudStack Row="true" Spacing="1">
                                <MudIconButton Icon="@Icons.Material.Filled.ShowChart" 
                                             Size="Size.Small" 
                                             Color="Color.Info"
                                             OnClick="@(() => OpenPriceHistoryDialog(context))" 
                                             title="View History" />
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                             Size="Size.Small" 
                                             Color="Color.Primary"
                                             OnClick="@(() => OpenUpdateInvestmentDialog(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.TrendingDown" 
                                             Size="Size.Small" 
                                             Color="Color.Warning"
                                             OnClick="@(() => OpenSellInvestmentDialog(context))" 
                                             Disabled="@(context.Status != "Active")" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                             Size="Size.Small" 
                                             Color="Color.Error"
                                             OnClick="@(() => DeleteInvestment(context))" />
                            </MudStack>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudPaper>
    </MudContainer>
}

@code {
    [Parameter]
    public string PortfolioId { get; set; } = string.Empty;

    private PortfolioResponseDto? _currentPortfolio;
    private HashSet<string> _fetchedSymbols = new();

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to state changes
        PortfolioState.StateChanged += (sender, args) => OnStateChanged();
        InvestmentState.StateChanged += (sender, args) => OnInvestmentStateChanged();
        MarketDataState.StateChanged += (sender, args) => StateHasChanged();

        // Start SignalR connection
        await SignalRService.StartConnectionAsync();
        SignalRService.OnPortfolioUpdated += HandlePortfolioUpdate;
        
        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        LoadPortfolioAndInvestments();
        if (!string.IsNullOrEmpty(PortfolioId) && Guid.TryParse(PortfolioId, out var id))
        {
            await SignalRService.JoinPortfolioGroupAsync(id);
        }
        await base.OnParametersSetAsync();
    }

    private void OnStateChanged()
    {
        _currentPortfolio = PortfolioState.Value.Portfolios.FirstOrDefault(p => p.Id == PortfolioId);
        StateHasChanged();
    }

    private void OnInvestmentStateChanged()
    {
        // When investments are loaded, fetch prices for them
        if (!InvestmentState.Value.IsLoading && InvestmentState.Value.Investments.Any())
        {
            foreach (var investment in InvestmentState.Value.Investments)
            {
                if (!_fetchedSymbols.Contains(investment.Symbol.Ticker))
                {
                    _fetchedSymbols.Add(investment.Symbol.Ticker);
                    Dispatcher.Dispatch(new FetchPriceAction(investment.Symbol.Ticker));
                }
            }
        }
        StateHasChanged();
    }

    private MarketPriceDto? GetMarketPrice(string symbol)
    {
        if (MarketDataState.Value.Prices.TryGetValue(symbol, out var price))
        {
            return price;
        }
        return null;
    }

    private void LoadPortfolioAndInvestments()
    {
        // Find the portfolio from the store
        _currentPortfolio = PortfolioState.Value.Portfolios.FirstOrDefault(p => p.Id == PortfolioId);

        // Load investments for this portfolio
        if (!string.IsNullOrEmpty(PortfolioId))
        {
            Dispatcher.Dispatch(new LoadInvestmentsAction(PortfolioId));
            _fetchedSymbols.Clear(); // Reset fetched symbols when reloading portfolio
        }
    }

    private async Task OpenAddInvestmentDialog()
    {
        if (string.IsNullOrEmpty(PortfolioId))
            return;

        var parameters = new DialogParameters
        {
            { "PortfolioId", PortfolioId }
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<AddInvestmentDialog>("Add Investment", parameters, options);
        await dialog.Result;
    }

    private async Task OpenUpdateInvestmentDialog(InvestmentResponseDto investment)
    {
        var parameters = new DialogParameters
        {
            { "Investment", investment }
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<UpdateInvestmentDialog>("Update Investment Value", parameters, options);
        await dialog.Result;
    }

    private async Task OpenSellInvestmentDialog(InvestmentResponseDto investment)
    {
        var parameters = new DialogParameters
        {
            { "Investment", investment }
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<SellInvestmentDialog>("Sell Investment", parameters, options);
        await dialog.Result;
    }

    private async Task OpenPriceHistoryDialog(InvestmentResponseDto investment)
    {
        var parameters = new DialogParameters
        {
            { "Symbol", investment.Symbol.Ticker }
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Large, 
            FullWidth = true 
        };

        // We can use a simple dialog that contains the PriceHistoryChart
        // Since we don't have a dedicated dialog component for this yet, 
        // we'll need to create one or use an inline dialog if MudBlazor supports it easily.
        // Better to create a wrapper dialog component.
        
        var dialog = await DialogService.ShowAsync<PriceHistoryDialog>($"Price History: {investment.Symbol.Ticker}", parameters, options);
        await dialog.Result;
    }

    private async Task OpenEditPortfolioDialog()
    {
        if (_currentPortfolio == null) return;

        var parameters = new DialogParameters
        {
            { "PortfolioId", PortfolioId },
            { "Name", _currentPortfolio.Name },
            { "Description", _currentPortfolio.Description ?? string.Empty }
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<EditPortfolioDialog>("Edit Portfolio", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled && result.Data is UpdatePortfolioRequest request)
        {
            try 
            {
                await PortfoliosApi.UpdatePortfolioAsync(PortfolioId, request);
                Snackbar.Add("Portfolio updated successfully", Severity.Success);
                // Reload portfolio to show changes
                Dispatcher.Dispatch(new LoadPortfoliosAction(UserState.Value.SelectedUserId!));
            }
            catch (Refit.ApiException ex)
            {
                var error = await ex.GetContentAsAsync<Dictionary<string, string>>();
                var message = error != null && error.ContainsKey("error") ? error["error"] : ex.Message;
                Snackbar.Add($"Failed to update portfolio: {message}", Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to update portfolio: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeletePortfolio()
    {
        if (_currentPortfolio == null) return;

        var result = await DialogService.ShowMessageBox(
            "Delete Portfolio",
            $"Are you sure you want to delete portfolio '{_currentPortfolio.Name}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await PortfoliosApi.DeletePortfolioAsync(PortfolioId);
                Snackbar.Add("Portfolio deleted successfully", Severity.Success);
                NavigationManager.NavigateTo("/");
            }
            catch (Refit.ApiException ex)
            {
                var error = await ex.GetContentAsAsync<Dictionary<string, string>>();
                var message = error != null && error.ContainsKey("error") ? error["error"] : ex.Message;
                Snackbar.Add($"Failed to delete portfolio: {message}", Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to delete portfolio: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteInvestment(InvestmentResponseDto investment)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete the investment in {investment.Symbol.Ticker}?",
            yesText: "Delete",
            cancelText: "Cancel"
        );

        if (result == true)
        {
            Dispatcher.Dispatch(new DeleteInvestmentAction(investment.Id));
            
            // Reload investments after a short delay
            await Task.Delay(500);
            Dispatcher.Dispatch(new LoadInvestmentsAction(PortfolioId));
            
            Snackbar.Add($"Investment {investment.Symbol.Ticker} deleted", Severity.Success);
        }
    }

    private Color GetGainLossColor(decimal amount)
    {
        if (amount > 0) return Color.Success;
        if (amount < 0) return Color.Error;
        return Color.Default;
    }

    private Color GetAssetTypeColor(string assetType)
    {
        return assetType.ToLower() switch
        {
            "stock" => Color.Primary,
            "bond" => Color.Secondary,
            "crypto" => Color.Tertiary,
            "etf" => Color.Info,
            _ => Color.Default
        };
    }

    private Color GetStatusColor(string status)
    {
        return status.ToLower() switch
        {
            "active" => Color.Success,
            "sold" => Color.Warning,
            "closed" => Color.Default,
            _ => Color.Default
        };
    }
    private void HandlePortfolioUpdate(Guid portfolioId, string message)
    {
        if (PortfolioId == portfolioId.ToString())
        {
            Snackbar.Add(message, Severity.Info);
            Dispatcher.Dispatch(new LoadInvestmentsAction(PortfolioId));
            // Also reload portfolio to get updated totals
            if (!string.IsNullOrEmpty(UserState.Value.SelectedUserId))
            {
                Dispatcher.Dispatch(new LoadPortfoliosAction(UserState.Value.SelectedUserId));
            } 
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (!string.IsNullOrEmpty(PortfolioId) && Guid.TryParse(PortfolioId, out var id))
        {
            await SignalRService.LeavePortfolioGroupAsync(id);
        }
        SignalRService.OnPortfolioUpdated -= HandlePortfolioUpdate;
    }
}

